<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>GenericIntegration.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BraintreeClient3.html">BraintreeClient3</a><ul class='methods'><li data-type='method'><a href="BraintreeClient3.html#init">init</a></li></ul></li><li><a href="BraintreeUI3.html">BraintreeUI3</a><ul class='methods'><li data-type='method'><a href="BraintreeUI3.html#destroy">destroy</a></li><li data-type='method'><a href="BraintreeUI3.html#init">init</a></li><li data-type='method'><a href="BraintreeUI3.html#postInit">postInit</a></li></ul></li><li><a href="BraintreeUtils.html">BraintreeUtils</a><ul class='methods'><li data-type='method'><a href="BraintreeUtils.html#decodeToken">decodeToken</a></li><li data-type='method'><a href="BraintreeUtils.html#getAccountSettings">getAccountSettings</a></li><li data-type='method'><a href="BraintreeUtils.html#getAVSChallenges">getAVSChallenges</a></li><li data-type='method'><a href="BraintreeUtils.html#is3DSEnabled">is3DSEnabled</a></li><li data-type='method'><a href="BraintreeUtils.html#parseError">parseError</a></li><li data-type='method'><a href="BraintreeUtils.html#toBoolean">toBoolean</a></li></ul></li><li><a href="ConfiguredClass.html">ConfiguredClass</a><ul class='methods'><li data-type='method'><a href="ConfiguredClass.html#execModuleFn">execModuleFn</a></li><li data-type='method'><a href="ConfiguredClass.html#init">init</a></li></ul></li><li><a href="CustomUI.html">CustomUI</a><ul class='methods'><li data-type='method'><a href="CustomUI.html#postInit">postInit</a></li><li data-type='method'><a href="CustomUI.html#tokenizeCard">tokenizeCard</a></li></ul></li><li><a href="DropinUI.html">DropinUI</a><ul class='methods'><li data-type='method'><a href="DropinUI.html#init">init</a></li></ul></li><li><a href="GenericIntegration.html">GenericIntegration</a><ul class='methods'><li data-type='method'><a href="GenericIntegration.html#destroy">destroy</a></li><li data-type='method'><a href="GenericIntegration.html#on3DSFail">on3DSFail</a></li><li data-type='method'><a href="GenericIntegration.html#onBypass3DS">onBypass3DS</a></li><li data-type='method'><a href="GenericIntegration.html#onPaymentMethodReceived">onPaymentMethodReceived</a></li><li data-type='method'><a href="GenericIntegration.html#onReady">onReady</a></li><li data-type='method'><a href="GenericIntegration.html#processError">processError</a></li><li data-type='method'><a href="GenericIntegration.html#set3DSecure">set3DSecure</a></li><li data-type='method'><a href="GenericIntegration.html#setFieldValue">setFieldValue</a></li><li data-type='method'><a href="GenericIntegration.html#submit">submit</a></li></ul></li><li><a href="HostedFieldsUI.html">HostedFieldsUI</a><ul class='methods'><li data-type='method'><a href="HostedFieldsUI.html#createFields">createFields</a></li><li data-type='method'><a href="HostedFieldsUI.html#postInit">postInit</a></li><li data-type='method'><a href="HostedFieldsUI.html#tokenizeCard">tokenizeCard</a></li></ul></li><li><a href="PayPalButtonUI.html">PayPalButtonUI</a><ul class='methods'><li data-type='method'><a href="PayPalButtonUI.html#destroy">destroy</a></li><li data-type='method'><a href="PayPalButtonUI.html#disablePaymentButton">disablePaymentButton</a></li><li data-type='method'><a href="PayPalButtonUI.html#enablePaymentButton">enablePaymentButton</a></li><li data-type='method'><a href="PayPalButtonUI.html#getButtonId">getButtonId</a></li><li data-type='method'><a href="PayPalButtonUI.html#hidePaymentMethod">hidePaymentMethod</a></li><li data-type='method'><a href="PayPalButtonUI.html#init">init</a></li><li data-type='method'><a href="PayPalButtonUI.html#postInit">postInit</a></li><li data-type='method'><a href="PayPalButtonUI.html#showPaymentMethod">showPaymentMethod</a></li><li data-type='method'><a href="PayPalButtonUI.html#teardownHTML">teardownHTML</a></li><li data-type='method'><a href="PayPalButtonUI.html#tokenize">tokenize</a></li></ul></li><li><a href="ThreeDSecure.html">ThreeDSecure</a><ul class='methods'><li data-type='method'><a href="ThreeDSecure.html#init">init</a></li><li data-type='method'><a href="ThreeDSecure.html#removeFrame">removeFrame</a></li><li data-type='method'><a href="ThreeDSecure.html#verifyCard">verifyCard</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-commonConf.html">Common configuration</a></li><li><a href="tutorial-customUI_.html">CustomUI</a></li><li><a href="tutorial-dropinUI_.html">DropinUI</a></li><li><a href="tutorial-hostedFieldsUI_.html">HostedFieldsUI</a></li><li><a href="tutorial-paypalButtonUI_.html">PayPalButtonUI</a></li><li><a href="tutorial-threeDSecure_.html">ThreeDSecure</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">GenericIntegration.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

/**
 * Abstract class that provides the backbone for a Braintree card payment integration
 * 
 * @author Eugen Mihailescu &lt;eugenmihailescux@gmail.com>
 * @license {@link https://www.gnu.org/licenses/gpl-3.0.txt|GPLv3}
 * @version 1.0
 * 
 * @class
 * @since 1.0
 * @param {Object}
 *            config - Default class configuration
 */
function GenericIntegration(config) {
    // call the superclass constructor
    ConfiguredClass.call(this, config);

    var that = this;

    // ///////////////////////////////
    // PRIVILEGED MEMBERS &amp; FUNCTIONS
    // \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

    /**
     * Appends a hidden fields to the integration form
     * 
     * @since 1.0
     * @param {string}
     *            name - The hidden field name to append
     * @param {string|number}
     *            value - The hidden field value
     */
    this.setFieldValue = function(name, value) {
        var field = $("input[name=\"" + name + "\"]");

        if (field.length) {
            field.val(value);
        } else {
            $("&lt;input>", {
                "type" : "hidden",
                "name" : name,
                "value" : value
            }).appendTo(that.form);
        }
    };

    /**
     * Submits the checkout form
     * 
     * @since 1.0
     * @param {string=}
     *            nonce - Not used in this version
     */
    this.submit = function(nonce) {
        that.form.off("submit").trigger("submit");
    };

    /**
     * The ThreeDSecure instance when provided via the constructor's {@link GenericIntegration|configuration}
     * 
     * @since 1.0
     * @member {(Object|boolean)=}
     * @default false
     */
    this.threeDSecure = config.threeDSecure || false;

    /**
     * The Braintree integration instance after a successful initialization
     * 
     * @since 1.0
     * @member {Object=}
     * @default null
     */
    this.integration_instance = null;

    /**
     * The class dependent integration type (should be overriden by a prticular integration subclass)
     * 
     * @since 1.0
     * @member {string=}
     * @default false
     */
    this.integrationType = config.integrationType || false;

    /**
     * The integration (jQuery) selector of the checkout form when provided via the constructor's
     * {@link GenericIntegration|configuration}
     * 
     * @since 1.0
     * @member {string=}
     * @default false
     */
    this.form = config.form || false;

    /**
     * The integration dependent input controls jQuery selectors when provided via the constructor's
     * {@link GenericIntegration|configuration}
     * 
     * @since 1.0
     * @member {Object=}
     * @default {}
     * @property {string=} non3DSPayment - The jQuery selector for the hidden input that is going to be set on non 3DS
     *           payments
     * @property {string=} paymentNonce - The jQuery selector for the hidden input that is going to be set with the payment
     *           method nonce to send to the server backend
     * @property {string=} paymentToken - The jQuery selector for the hidden input that represents the Braintree Vault payment
     *           token
     * @property {string=} card_number - The jQuery selector for the card number input element
     * @property {string=} expiry_date - The jQuery selector for the card expiry date input element
     * @property {string=} cvv_number - The jQuery selector for the card CVV number input element
     * @property {string=} postal_code - The jQuery selector for the card postal code input element (used by AVS rules)
     * @property {string=} street_address - The jQuery selector for the card street address input element (used by AVS rules)
     * @property {string=} amount - The jQuery selector for the amount input element (used by {@link PayPalButtonUI} button)
     * @property {string=} currency - The jQuery selector for the currency input element (used by {@link PayPalButtonUI}
     *           button)
     * @property {string=} deviceData - The jQuery selector for the hidden Braintree Vault data-collector element (used by
     *           {@link PayPalButtonUI} button)
     * @see {@link GenericIntegration#onBypass3DS|onBypass3DS}
     */
    this.inputs = config.inputs || {};

    /**
     * The current integration client token as provided via the constructor's {@link GenericIntegration|configuration}
     * 
     * @member {string}
     */
    this.client_token = config.token;

    /**
     * Whether the current integration should allow 3DS cards only. Provided via the constructor's
     * {@link GenericIntegration|configuration}
     * 
     * @since 1.0
     * @member {boolean=}
     * @default false
     */
    this.allow3DSPaymentsOny = config.allow3DSPaymentsOny || false;

    /**
     * Overrides the {@link GenericIntegration#allow3DSPaymentsOny|allow3DSPaymentsOny} property as following: when TRUE and
     * when a non-3DS card but merchant has AVS rules then accept the payment
     * 
     * @since 1.0
     * @member {boolean}
     * @default false
     */
    // (hopefully it will be validated by the gateway)
    this.ignore3DSIfAVS = config.ignore3DSIfAVS || false;

    /**
     * A callback to notify on error as provided via the constructor's {@link GenericIntegration|configuration}
     * 
     * @since 1.0
     * @member {callback=}
     * @default {@link ConfiguredClass#noop|noop}
     */
    this.onError = config.onError || this.noop;

    // /////////////////////////////
    // PRIVILEGED FUNCTIONS
    // \\\\\\\\\\\\\\\\\\\\\\\\\\\\\

    /**
     * Callback to backup the BT integration handle necessary on instance destroy On error it destroys&amp;recreates the
     * integration then notify the error callback.
     * 
     * @since 1.0
     * @param {string=}
     *            message - When defined it is passed to the {@link GenericIntegration#onError|onError} callback
     */
    this.processError = function(message) {
        if (that.integration_instance) {
            that.integration_instance.teardown(function(err) {
                if (err) {
                    // we don't want to print out these errors (?!)
                    console.error("Could not tear down " + that.integrationType + " integration!");
                } else {
                    that.integration_instance = null;
                    that.init();
                }
            });
        }

        if (that.UNDEF !== typeof message) {
            that.onError(message);
        }
    };

    /**
     * A callback called when the integration is created successfully.
     * 
     * @since 1.0
     * @param {Object}
     *            integration - The instance of the created integration object
     */
    this.onReady = function(integration) {
        that.integration_instance = integration;
    };

    /**
     * Callback notified automatically when the 3DS authentication failure
     * 
     * @since 1.0
     * @see {@link GenericIntegration#onPaymentMethodReceived|onPaymentMethodReceived}
     */
    this.on3DSFail = function() {
        that.processError("3DS_FAILED");
    };

    /**
     * Callback notified when 3DS is bypassed by AVS rules
     * 
     * @since 1.0
     * @param {Object}
     *            response - The Braintree
     *            {@link https://braintree.github.io/braintree-web/3.8.0/ThreeDSecure.html#~verifyPayload|verifyPaylod} object
     *            sent by the {@link ThreeDSecure#verifyCard}
     * @see {@link GenericIntegration#onPaymentMethodReceived|onPaymentMethodReceived}
     */
    this.onBypass3DS = function(response) {
        if (that.ignore3DSIfAVS &amp;&amp; that.execModuleFn("utils", "getAVSChallenges").length) {
            that.setFieldValue(that.inputs.non3DSPayment, true);

            return true;
        }

        return false;
    };

    /**
     * A callback called after a valid tokenization that sends the payment method nonce
     * 
     * @since 1.0
     * @param {Object}
     *            paymentMethodInfo - An object that encapsulates the properties and callbacks passed by the caller
     * @see {@link CustomUI#tokenizeCard}
     * @see {@link HostedFieldsUI#tokenizeCard}
     * @see {@link PayPalButtonUI#tokenize}
     * @see {@link DropinUI#clientOptions}
     */
    this.onPaymentMethodReceived = function(paymentMethodInfo) {
        // CreditCard [not:PayPalAccount|ApplePayCard|AndroidPayCard]
        if ("CreditCard" === paymentMethodInfo.type) {
            if (that.threeDSecure &amp;&amp; that.execModuleFn("utils", "is3DSEnabled")) {
                that.threeDSecure.verifyCard({
                    paymentMethodInfo : paymentMethodInfo,
                    onSuccess : that.submit,
                    onError : that.on3DSFail,
                    onBypass3DS : that.onBypass3DS,
                });
                return;
            }
            if (that.allow3DSPaymentsOny) {
                return that.on3DSFail();
            }
        }

        that.setFieldValue(that.inputs.paymentNonce, paymentMethodInfo.nonce);

        that.submit();
    };

    /**
     * Set the ThreeDSecure instance to use for 3DS-authentication
     * 
     * @since 1.0
     * @param {Object}
     *            instance - A {@link ThreeDSecure} instance to be used if 3DS authentication is required
     */
    this.set3DSecure = function(instance) {
        that.threeDSecure = instance;
    };

}

GenericIntegration.prototype = Object.create(ConfiguredClass.prototype);
GenericIntegration.prototype.constructor = GenericIntegration;

/**
 * Tear-down the integration (clean-up DOM, events, etc)
 * 
 * @since 1.0
 * @param {callback=}
 *            onDone - A callback function to be called on destroy done.
 */
GenericIntegration.prototype.destroy = function(onDone) {
    var that = this;

    onDone = onDone || this.noop;

    if (this.integration_instance) {
        this.integration_instance.teardown(function(err) {
            if (err) {
                console.error("Could not tear down " + that.integrationType + " integration!");
            } else {
                that.integration_instance = null;
            }
            onDone();
        });
    } else {
        onDone();
    }
};</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Feb 19 2017 22:43:53 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
