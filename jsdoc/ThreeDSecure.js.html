<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ThreeDSecure.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BraintreeClient3.html">BraintreeClient3</a><ul class='methods'><li data-type='method'><a href="BraintreeClient3.html#init">init</a></li></ul></li><li><a href="BraintreeUI3.html">BraintreeUI3</a><ul class='methods'><li data-type='method'><a href="BraintreeUI3.html#destroy">destroy</a></li><li data-type='method'><a href="BraintreeUI3.html#init">init</a></li><li data-type='method'><a href="BraintreeUI3.html#postInit">postInit</a></li></ul></li><li><a href="BraintreeUtils.html">BraintreeUtils</a><ul class='methods'><li data-type='method'><a href="BraintreeUtils.html#decodeToken">decodeToken</a></li><li data-type='method'><a href="BraintreeUtils.html#getAccountSettings">getAccountSettings</a></li><li data-type='method'><a href="BraintreeUtils.html#getAVSChallenges">getAVSChallenges</a></li><li data-type='method'><a href="BraintreeUtils.html#is3DSEnabled">is3DSEnabled</a></li><li data-type='method'><a href="BraintreeUtils.html#parseError">parseError</a></li><li data-type='method'><a href="BraintreeUtils.html#toBoolean">toBoolean</a></li></ul></li><li><a href="ConfiguredClass.html">ConfiguredClass</a><ul class='methods'><li data-type='method'><a href="ConfiguredClass.html#execModuleFn">execModuleFn</a></li><li data-type='method'><a href="ConfiguredClass.html#init">init</a></li></ul></li><li><a href="CustomUI.html">CustomUI</a><ul class='methods'><li data-type='method'><a href="CustomUI.html#postInit">postInit</a></li><li data-type='method'><a href="CustomUI.html#tokenizeCard">tokenizeCard</a></li></ul></li><li><a href="DropinUI.html">DropinUI</a><ul class='methods'><li data-type='method'><a href="DropinUI.html#init">init</a></li></ul></li><li><a href="GenericIntegration.html">GenericIntegration</a><ul class='methods'><li data-type='method'><a href="GenericIntegration.html#destroy">destroy</a></li><li data-type='method'><a href="GenericIntegration.html#on3DSFail">on3DSFail</a></li><li data-type='method'><a href="GenericIntegration.html#onBypass3DS">onBypass3DS</a></li><li data-type='method'><a href="GenericIntegration.html#onPaymentMethodReceived">onPaymentMethodReceived</a></li><li data-type='method'><a href="GenericIntegration.html#onReady">onReady</a></li><li data-type='method'><a href="GenericIntegration.html#processError">processError</a></li><li data-type='method'><a href="GenericIntegration.html#set3DSecure">set3DSecure</a></li><li data-type='method'><a href="GenericIntegration.html#setFieldValue">setFieldValue</a></li><li data-type='method'><a href="GenericIntegration.html#submit">submit</a></li></ul></li><li><a href="HostedFieldsUI.html">HostedFieldsUI</a><ul class='methods'><li data-type='method'><a href="HostedFieldsUI.html#createFields">createFields</a></li><li data-type='method'><a href="HostedFieldsUI.html#postInit">postInit</a></li><li data-type='method'><a href="HostedFieldsUI.html#tokenizeCard">tokenizeCard</a></li></ul></li><li><a href="PayPalButtonUI.html">PayPalButtonUI</a><ul class='methods'><li data-type='method'><a href="PayPalButtonUI.html#destroy">destroy</a></li><li data-type='method'><a href="PayPalButtonUI.html#disablePaymentButton">disablePaymentButton</a></li><li data-type='method'><a href="PayPalButtonUI.html#enablePaymentButton">enablePaymentButton</a></li><li data-type='method'><a href="PayPalButtonUI.html#getButtonId">getButtonId</a></li><li data-type='method'><a href="PayPalButtonUI.html#hidePaymentMethod">hidePaymentMethod</a></li><li data-type='method'><a href="PayPalButtonUI.html#init">init</a></li><li data-type='method'><a href="PayPalButtonUI.html#postInit">postInit</a></li><li data-type='method'><a href="PayPalButtonUI.html#showPaymentMethod">showPaymentMethod</a></li><li data-type='method'><a href="PayPalButtonUI.html#teardownHTML">teardownHTML</a></li><li data-type='method'><a href="PayPalButtonUI.html#tokenize">tokenize</a></li></ul></li><li><a href="ThreeDSecure.html">ThreeDSecure</a><ul class='methods'><li data-type='method'><a href="ThreeDSecure.html#init">init</a></li><li data-type='method'><a href="ThreeDSecure.html#removeFrame">removeFrame</a></li><li data-type='method'><a href="ThreeDSecure.html#verifyCard">verifyCard</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-commonConf.html">Common configuration</a></li><li><a href="tutorial-customUI_.html">CustomUI</a></li><li><a href="tutorial-dropinUI_.html">DropinUI</a></li><li><a href="tutorial-hostedFieldsUI_.html">HostedFieldsUI</a></li><li><a href="tutorial-paypalButtonUI_.html">PayPalButtonUI</a></li><li><a href="tutorial-threeDSecure_.html">ThreeDSecure</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">ThreeDSecure.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
/**
 * Wrapper class for Braintree ThreeDSecure authentication flow
 * 
 * @author Eugen Mihailescu &lt;eugenmihailescux@gmail.com>
 * @license {@link https://www.gnu.org/licenses/gpl-3.0.txt|GPLv3}
 * @version 1.0
 * 
 * @class
 * @since 1.0
 * @param config
 *            The default authentication configuration
 * 
 * @see https://braintree.github.io/braintree-web/3.6.3/ThreeDSecure.html
 */
function ThreeDSecure(config) {
    // super class constructor
    BraintreeClient3.call(this, config);

    // /////////////////////////////
    // PRIVATE METHODS &amp; FUNCTIONS
    // \\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    var that = this;

    // returns true if the `data` shows the liability shifted to bank
    function isLiabilityShifted(data) {
        var result = data.liabilityShifted || data.liabilityShiftPossible;
        result = result
                || (data.verificationDetails &amp;&amp; (data.verificationDetails.liabilityShifted || data.verificationDetails.liabilityShiftPossible));
        return result;
    }

    // the helper function to integrate the 3DS popup in our modal frame
    function addFrame(err, iframe) {
        if (that.frame3ds) {
            that.frame3ds.bankFrame.append($(iframe));
            that.frame3ds.modal.removeClass(that.frame3ds.hidden);
        }
    }

    // ///////////////////////////////
    // PRIVILEGED MEMBERS &amp; FUNCTIONS
    // \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

    /**
     * The instance to the Braintree ThreeDSecure object
     * 
     * @since 1.0
     * @member {Object}
     * @default
     */
    this.bt_threeDSecure = false;

    /**
     * The form inputs (here we need only access to `amount` field)
     * 
     * @since 1.0
     * @member {Object}
     * @property {string} amount - The jQuery selector for the amount HTML element
     */
    this.inputs = config.inputs;

    /**
     * The 3DS authentication wrapper frame HTML elements as provided via the constructor's {@link ThreeDSecure|configuration}
     * 
     * @since 1.0
     * @member {Object}
     * @property {Object} bankFrame - The inner jQuery object that represents the 3DS bank frame body (eg. a DIV)
     * @property {Object} modal - The outer jQuery object that represents the 3DS bank modal frame (eg. a DIV)
     * @property {string} hidden - The CSS class name used to hide the 3DS bank frame
     * @property {Object} closeBtn - The jQuery object that represents the 3DS bank frame close button
     */
    this.frame3ds = config.frame3ds;

    /**
     * Set to true if integration accepts 3DS cards only
     * 
     * @since 1.0
     * @member {boolean}
     * @default false
     */
    this.allow3DSPaymentsOny = config.allow3DSPaymentsOny || false;

    /**
     * Overrides the {@link ThreeDSecure#allow3DSPaymentsOny} option: if non-3DS card but merchant has AVS rules then accept
     * the payment. Hopefully it will be validated by the gateway.
     * 
     * @since 1.0
     * @member {boolean}
     * @default false
     */
    this.ignore3DSIfAVS = config.ignore3DSIfAVS || false;

    /**
     * Callback to notify after the 3DS instance is created|ready
     * 
     * @since 1.0
     * @member {callback}
     * @default {@link ConfiguredClass#noop|noop}
     */
    this.onReady = config.onReady || this.noop;

    /**
     * Callback to notify when the user closes the 3DS popup
     * 
     * @since 1.0
     * @member {callback}
     * @default {@link ConfiguredClass#noop|noop}
     */
    this.onUserClose = config.onUserClose || this.noop;

    /**
     * Callback to notify when 3DS liability cannot be shifted to bank
     * 
     * @since 1.0
     * @member {callback}
     * @default {@link ConfiguredClass#noop|noop}
     */
    this.onFailLiabilityShift = config.onFailLiabilityShift || this.noop

    /**
     * Callback to notify when the AVS is tried due to 3DS liability shift failure
     * 
     * @since 1.0
     * @member {callback}
     * @default {@link ConfiguredClass#noop|noop}
     */
    this.onUseAVSLiabilityShiftFailed = config.onUseAVSLiabilityShiftFailed || this.noop

    /**
     * The Remove the 3DS popup from our modal frame
     * 
     * @since 1.0
     * @function
     * @param {Object}
     *            error - The Braintree error object passed to the function when called
     * @param {string}
     *            paymentMethod - The payment method passed that called this function
     */
    this.removeFrame = function(error, paymentMethod) {
        var iframe = that.frame3ds.bankFrame.children('iframe');
        that.frame3ds.modal.addClass(that.frame3ds.hidden);
        iframe.remove();
    };

    /**
     * Launches the 3DS authentication popup
     * 
     * @since 1.0
     * @param {Object}
     *            data - An object that contains the paymentMethodInfo and the callback used while calling the
     *            {@link https://braintree.github.io/braintree-web/3.6.3/ThreeDSecure.html#verifyCard|Braintree's verifyCard}
     *            method
     * @see GenericIntegration#onPaymentMethodReceived
     */
    this.verifyCard = function(data) {
        that.bt_threeDSecure.verifyCard({
            amount : $(that.inputs.amount).val(),
            nonce : data.paymentMethodInfo.nonce,
            addFrame : addFrame,
            removeFrame : that.removeFrame
        }, function(err, response) {
            if (err) {
                that.onError(that.execModuleFn('utils', 'parseError', err));
                return;
            }

            var success = isLiabilityShifted(response);

            if (!success &amp;&amp; that.ignore3DSIfAVS &amp;&amp; that.execModuleFn('utils', 'getAVSChallenges').length) {
                success = data.onBypass3DS ? data.onBypass3DS(response) : true;

                if (that.onUseAVSLiabilityShiftFailed) {
                    that.onUseAVSLiabilityShiftFailed(response);
                }
            }

            success = success || !that.allow3DSPaymentsOny;

            if (!success) {
                data.onError();
                that.onFailLiabilityShift(response);
            } else {
                data.onSuccess(response.nonce);
            }
        });
    };

    this.init();
}

ThreeDSecure.prototype = Object.create(BraintreeClient3.prototype);
ThreeDSecure.prototype.constructor = ThreeDSecure;

/**
 * @inheritdoc
 * @override
 */
ThreeDSecure.prototype.init = function() {
    var that = this;
    this.frame3ds.closeBtn.off('click').on('click', function() {
        that.bt_threeDSecure.cancelVerifyCard(that.removeFrame);
        that.onError();
        that.onUserClose();
    });

    this.onClientReady = function(clientInstance) {
        braintree.threeDSecure.create({
            client : clientInstance
        }, function(threeDSecureErr, threeDSecureInstance) {
            if (threeDSecureErr) {
                that.onError(threeDSecureErr.message);
                return;
            }

            that.bt_threeDSecure = threeDSecureInstance;

            that.onReady(that);
        });
    };

    BraintreeClient3.prototype.init.call(this);
};</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Feb 19 2017 22:43:53 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
